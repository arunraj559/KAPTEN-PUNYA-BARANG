<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Saldo Kapten â€” Premium Holographic Edition</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg: #0f1419;
  --card: #1a1f28;
  --border: rgba(255, 215, 0, 0.15);
  --gold: #ffd700;
  --silver: #c0c0c0;
  --accent: #ffa500;
  --text: #f5e6d3;
  --text-muted: #a8957a;
  --success: #22cc88;
  --danger: #ff4444;
}

*{box-sizing:border-box; margin:0; padding:0;}

body{
  font-family: 'Inter', system-ui, sans-serif;
  background: linear-gradient(135deg, #0a0e14 0%, #151921 100%);
  color: var(--text);
  min-height: 100vh;
}

.container{
  max-width: 1400px;
  margin: 0 auto;
  padding: 24px;
}

header.top{
  margin-bottom: 32px;
}

.logo-title{
  font-family: 'Exo 2', sans-serif;
  font-size: 36px;
  font-weight: 800;
  background: linear-gradient(135deg, #ffd700 0%, #ffa500 50%, #c0c0c0 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: 2px;
  margin-bottom: 8px;
  text-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
}

.subtitle{
  font-size: 13px;
  color: var(--text-muted);
  font-weight: 500;
}

.controls{
  display: flex;
  gap: 12px;
  margin-top: 20px;
  flex-wrap: wrap;
  align-items: center;
}

.glass-input, .glass-select{
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  padding: 10px 14px;
  border-radius: 8px;
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  transition: all 0.3s ease;
  min-width: 180px;
}

.glass-input::placeholder{
  color: var(--text-muted);
}

.glass-input:focus, .glass-select:focus{
  outline: none;
  border-color: rgba(255, 215, 0, 0.4);
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
}

.btn{
  background: linear-gradient(135deg, var(--gold), var(--accent));
  color: #111;
  padding: 10px 18px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-family: 'Exo 2', sans-serif;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
  transition: all 0.3s ease;
  font-size: 14px;
}

.btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
}

.btn:active{
  transform: translateY(0);
}

.btn-edit{
  background: rgba(255, 165, 0, 0.2);
  color: var(--accent);
  padding: 6px 12px;
  font-size: 12px;
  border: 1px solid var(--accent);
}

.btn-edit:hover{
  background: rgba(255, 165, 0, 0.4);
  transform: scale(1.05);
}

.summary-grid{
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 20px;
  margin-bottom: 32px;
}

.card{
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  position: relative;
  overflow: hidden;
}

.card::before{
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--gold), var(--silver), var(--accent));
  opacity: 0.6;
}

.card.big{
  grid-column: span 6;
}

.card.small{
  grid-column: span 2;
}

.card.warning{
  animation: pulse-glow 2s ease-in-out infinite;
  box-shadow: 0 0 30px rgba(255, 68, 68, 0.3);
}

.card.success{
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
}

.card-title{
  font-family: 'Exo 2', sans-serif;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.card-value{
  font-family: 'Exo 2', sans-serif;
  font-size: 32px;
  font-weight: 800;
  background: linear-gradient(135deg, #ffd700 0%, #ffa500 50%, #c0c0c0 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-variant-numeric: tabular-nums;
}

.card-value.negative{
  background: none;
  -webkit-text-fill-color: var(--danger);
  color: var(--danger);
}

.card-subtitle{
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 8px;
}

.table-card{
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.table-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.table-title{
  font-family: 'Exo 2', sans-serif;
  font-size: 20px;
  font-weight: 800;
  background: linear-gradient(135deg, #ffd700 0%, #ffa500 50%, #c0c0c0 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: 1.5px;
}

table{
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

thead th{
  font-family: 'Exo 2', sans-serif;
  font-size: 12px;
  font-weight: 700;
  text-align: left;
  padding: 14px 12px;
  border-bottom: 2px solid var(--border);
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

tbody td{
  padding: 14px 12px;
  border-bottom: 1px dashed rgba(255, 215, 0, 0.1);
}

tbody tr{
  transition: all 0.2s ease;
}

tbody tr:hover{
  background: rgba(255, 215, 0, 0.05);
}

tbody tr.row-negative{
  background: rgba(255, 68, 68, 0.12);
  border-left: 4px solid var(--danger);
  animation: pulse-glow 2s ease-in-out infinite;
}

tbody tr.row-warning{
  background: rgba(255, 68, 68, 0.08);
}

tbody tr.row-off{
  background: rgba(255, 68, 68, 0.08);
  border-left: 4px solid var(--danger);
}

.pill{
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-family: 'Exo 2', sans-serif;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.pill.success{
  background: rgba(34, 204, 136, 0.15);
  color: var(--success);
  border: 1px solid rgba(34, 204, 136, 0.3);
  box-shadow: 0 0 15px rgba(34, 204, 136, 0.2);
}

.pill.danger{
  background: rgba(255, 68, 68, 0.15);
  color: var(--danger);
  border: 1px solid rgba(255, 68, 68, 0.3);
  box-shadow: 0 0 15px rgba(255, 68, 68, 0.2);
  animation: pulse-glow 2s ease-in-out infinite;
}

.pill.kotor{
  background: rgba(255, 68, 68, 0.15);
  color: var(--danger);
  border: 1px solid rgba(255, 68, 68, 0.3);
}

.pill.bersih{
  background: rgba(34, 204, 136, 0.15);
  color: var(--success);
  border: 1px solid rgba(34, 204, 136, 0.3);
}

.modal-overlay{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-overlay.active{
  display: flex;
}

.modal-content{
  background: linear-gradient(135deg, rgba(26, 31, 40, 0.98) 0%, rgba(15, 20, 25, 0.98) 100%);
  border: 2px solid rgba(255, 68, 68, 0.5);
  border-radius: 16px;
  padding: 32px;
  max-width: 700px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 0 80px rgba(255, 68, 68, 0.6), inset 0 0 50px rgba(255, 68, 68, 0.1);
  animation: slideIn 0.4s ease-out;
}

@keyframes slideIn{
  from{
    transform: translateY(-50px) scale(0.95);
    opacity: 0;
  }
  to{
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

.modal-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  border-bottom: 2px solid rgba(255, 68, 68, 0.3);
  padding-bottom: 16px;
}

.modal-title{
  font-family: 'Exo 2', sans-serif;
  font-size: 28px;
  font-weight: 800;
  background: linear-gradient(135deg, #ff6666 0%, #ff4444 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.modal-close{
  background: rgba(255, 68, 68, 0.2);
  border: 1px solid rgba(255, 68, 68, 0.3);
  color: var(--danger);
  font-size: 28px;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 40px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close:hover{
  background: rgba(255, 68, 68, 0.4);
  transform: scale(1.1);
}

.alert-item{
  background: linear-gradient(135deg, rgba(255, 68, 68, 0.15) 0%, rgba(255, 68, 68, 0.05) 100%);
  border: 1px solid rgba(255, 68, 68, 0.4);
  border-left: 4px solid var(--danger);
  border-radius: 10px;
  padding: 18px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.alert-info h3{
  font-family: 'Exo 2', sans-serif;
  font-size: 16px;
  font-weight: 800;
  color: var(--danger);
  margin-bottom: 8px;
}

.alert-info p{
  font-size: 13px;
  color: var(--text);
  margin: 4px 0;
}

.alert-info p strong{
  color: var(--text-muted);
}

.alert-value{
  font-family: 'Exo 2', sans-serif;
  font-size: 20px;
  font-weight: 800;
  color: var(--danger);
  text-align: right;
  min-width: 150px;
}

.modal-footer{
  display: flex;
  gap: 12px;
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid rgba(255, 68, 68, 0.2);
  justify-content: flex-end;
}

.btn-modal{
  padding: 10px 20px;
  border-radius: 8px;
  border: 1px solid rgba(255, 68, 68, 0.3);
  background: rgba(255, 68, 68, 0.1);
  color: var(--danger);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Exo 2', sans-serif;
}

.btn-modal:hover{
  background: rgba(255, 68, 68, 0.2);
  transform: translateY(-2px);
}

.modal-form{
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-group{
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label{
  font-family: 'Exo 2', sans-serif;
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-group input, .form-group select{
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 68, 68, 0.3);
  border-radius: 8px;
  padding: 10px 14px;
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  transition: all 0.3s ease;
}

.form-group input:focus, .form-group select:focus{
  outline: none;
  border-color: rgba(255, 68, 68, 0.6);
  box-shadow: 0 0 15px rgba(255, 68, 68, 0.2);
  background: rgba(255, 68, 68, 0.05);
}

.btn-save{
  background: linear-gradient(135deg, var(--gold), var(--accent));
  color: #111;
  padding: 12px 24px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-family: 'Exo 2', sans-serif;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.btn-save:hover{
  transform: translateY(-2px);
  box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
}

.toast-container{
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9998;
}

.toast{
  background: linear-gradient(135deg, rgba(26, 31, 40, 0.95) 0%, rgba(15, 20, 25, 0.95) 100%);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
  color: var(--text);
  font-family: 'Exo 2', sans-serif;
  font-size: 13px;
  box-shadow: 0 0 40px rgba(255, 68, 68, 0.4);
  animation: slideInUp 0.3s ease-out, slideOutDown 0.3s ease-in 4.7s forwards;
  max-width: 400px;
}

@keyframes slideInUp{
  from{
    transform: translateY(20px);
    opacity: 0;
  }
  to{
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideOutDown{
  from{
    transform: translateY(0);
    opacity: 1;
  }
  to{
    transform: translateY(20px);
    opacity: 0;
  }
}

@keyframes pulse-glow{
  0%, 100%{ opacity: 1; }
  50%{ opacity: 0.7; }
}

@media (max-width: 900px){
  .summary-grid{
    grid-template-columns: repeat(6, 1fr);
  }
  .card.big, .card.small{
    grid-column: span 6;
  }
  .controls{
    flex-direction: column;
    align-items: stretch;
  }
  .glass-input, .glass-select, .btn{
    width: 100%;
  }
}

@media (max-width: 600px){
  .logo-title{
    font-size: 24px;
  }
  table{
    font-size: 12px;
  }
  thead th, tbody td{
    padding: 10px 8px;
  }
  .modal-content{
    padding: 20px;
  }
  .modal-title{
    font-size: 22px;
  }
}
</style>
</head>
<body>
  <div class="modal-overlay" id="alertModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">âš  SALDO KRITIKAL</div>
        <button class="modal-close" id="alertClose">&times;</button>
      </div>
      <div id="alertList"></div>
      <div class="modal-footer">
        <button class="btn-modal" id="alertCloseBtnFooter">Tutup</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">âœ EDIT REKENING</div>
        <button class="modal-close" id="editClose">&times;</button>
      </div>
      <form class="modal-form" id="editForm">
        <div class="form-group">
          <label>Nama Rekening</label>
          <input type="text" id="editNama" readonly style="opacity: 0.7;">
        </div>
        <div class="form-group">
          <label>No. Rekening</label>
          <input type="text" id="editRekening" required>
        </div>
        <div class="form-group">
          <label>Saldo</label>
          <input type="text" id="editSaldo" required>
        </div>
        <div class="form-group">
          <label>Biaya Harian</label>
          <input type="text" id="editBiaya" required>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="editStatus" required>
            <option value="ON">ON</option>
            <option value="OFF">OFF</option>
          </select>
        </div>
        <button type="button" class="btn-save" id="editSaveBtn">SIMPAN PERUBAHAN</button>
      </form>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <header class="top">
      <div class="logo-title">ğƒğ€ğ’ğ‡ğğğ€ğ‘ğƒ ğ’ğ€ğ‹ğƒğ ğŠğ€ğğ“ğ„ğ</div>
      <div class="subtitle"></div>

      <div class="controls">
        <input id="search" type="search" class="glass-input" placeholder="ğŸ” Cari nama atau rekening..." />
        
        <select id="accountType" class="glass-select">
          <option value="all">ğŸ“Š Semua Rekening</option>
          <option value="wd">ğŸ’¸ WD Saja</option>
          <option value="kas">ğŸ¦ Bank KAS Saja</option>
        </select>

        <select id="wdFilter" class="glass-select">
          <option value="all">Tampilkan Semua</option>
          <option value="kotor">WD Kotor (15)</option>
          <option value="bersih">WD Bersih (86)</option>
        </select>

        <select id="viewFilter" class="glass-select">
          <option value="all">Tampilkan Semua</option>
          <option value="on">Hanya ON</option>
          <option value="off">Hanya OFF</option>
        </select>

        <button class="btn" id="refreshBtn">âŸ³ Refresh dari Google Sheets</button>
      </div>
    </header>

    <section class="summary-grid">
      <div class="card big success">
        <div class="card-title">Total Saldo Aktif</div>
        <div class="card-value" id="totalSaldo">Rp 0</div>
        <div class="card-subtitle">Rekening ON </div>
      </div>

      <div class="card small" id="cardNegative" style="display:none">
        <div class="card-title">Saldo Minus</div>
        <div class="card-value negative" id="countNegative">0</div>
        <div class="card-subtitle">Perlu Perhatian!</div>
      </div>

      <div class="card small" id="cardLow">
        <div class="card-title">Saldo Mau Habis</div>
        <div class="card-value" id="countLow">0</div>
        <div class="card-subtitle">â‰¤ Rp 2.000.000</div>
      </div>

      <div class="card small">
        <div class="card-title">Rekening Aktif</div>
        <div class="card-value" id="countOn">0</div>
        <div class="card-subtitle">Status ON</div>
      </div>
    </section>

    <div class="table-card" id="wdTableCard">
      <div class="table-header">
        <h3 class="table-title">ğƒğ€ğ“ğ€ ğ‘ğ„ğŠğ„ğğˆğğ† ğğ€ğğŠ ğ–ğˆğ“ğ‡ğƒğ‘ğ€ğ–</h3>
        <div class="subtitle">WD Accounts</div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:22%">Nama Rekening</th>
            <th style="width:12%">Saldo</th>
            <th style="width:14%">No. Rekening</th>
            <th style="width:14%">Biaya Harian</th>
            <th style="width:8%">Status</th>
            <th style="width:12%">Tipe WD</th>
            <th style="width:18%">Aksi</th>
          </tr>
        </thead>
        <tbody id="wdTableBody"></tbody>
      </table>
    </div>

    <div class="table-card" id="kasTableCard" style="display:none">
      <div class="table-header">
        <h3 class="table-title">ğƒğ€ğ“ğ€ ğ‘ğ„ğŠğ„ğğˆğğ† ğğ€ğğŠ ğŠğ€ğ’</h3>
        <div class="subtitle">KAS Accounts</div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:24%">Nama Rekening</th>
            <th style="width:18%">Saldo</th>
            <th style="width:22%">No. Rekening</th>
            <th style="width:18%">Status</th>
            <th style="width:18%">Aksi</th>
          </tr>
        </thead>
        <tbody id="kasTableBody"></tbody>
      </table>
    </div>
  </div>

<script>
const API_KEY = "AIzaSyDCHy6x2rebgFUgBmJWZmWXkhw1lupJStE";
const SPREADSHEET_ID = "1rkGN7U659qbpUfNA0pz-IsDvDLvgpOqm4XXoB8BmieI";
const SHEET_NAME = "Sheet2";
const RANGE = `${SHEET_NAME}!A1:E999`;

const WD_KOTOR_NAMES = [
  "WD BCA G1", "WD BCA G2", "WD BCA G3", "WD BCA G4", "WD BCA G5",
  "WD BCA G6", "WD BCA G7", "WD BCA G8", "WD BCA G9", "WD BCA G10",
  "WD BRI G1", "WD BRI G2",
  "WD CIMB G1", "WD CIMB G2",
  "BANK WD DANAMON G1"
];

let allAccounts = [];
let shouldShowAlert = false;

function fmtIDR(n){
  const isNegative = n < 0;
  const absVal = Math.abs(n);
  const formatted = new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0,
  }).format(absVal);
  return isNegative ? `-${formatted}` : formatted;
}

function parseNumber(v){
  if(v==null) return 0;
  const s = String(v).trim();
  const isNegative = s.includes('-');
  const cleaned = s.replace(/[^0-9]/g,'');
  const n = Number(cleaned);
  const result = isNaN(n) ? 0 : n;
  return isNegative ? -result : result;
}

function isWdKotor(name){
  return WD_KOTOR_NAMES.some(kotor => name.toUpperCase().includes(kotor));
}

async function fetchSheetValues(){
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;
  const res = await fetch(url);
  if(!res.ok){
    throw new Error('HTTP '+res.status+': '+await res.text());
  }
  const json = await res.json();
  return json.values || [];
}

function showToast(message){
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 5000);
}

function openEditModal(nama){
  const account = allAccounts.find(a => a.nama === nama);
  if(!account) return;
  
  document.getElementById('editNama').value = account.nama;
  document.getElementById('editRekening').value = account.rekening;
  document.getElementById('editSaldo').value = account.saldo;
  document.getElementById('editBiaya').value = account.biaya;
  document.getElementById('editStatus').value = account.keterangan;
  
  document.getElementById('editModal').classList.add('active');
}

function closeEditModal(){
  document.getElementById('editModal').classList.remove('active');
}

function closeAlertModal(){
  document.getElementById('alertModal').classList.remove('active');
}

function showAlertModal(negativeAccounts, lowWdAccounts){
  const hasNegative = negativeAccounts.length > 0;
  const hasLow = lowWdAccounts.length > 0;
  
  if(!hasNegative && !hasLow) return;
  
  const listContainer = document.getElementById('alertList');
  listContainer.innerHTML = '';
  
  negativeAccounts.forEach(acc => {
    const item = document.createElement('div');
    item.className = 'alert-item';
    item.innerHTML = `
      <div class="alert-info">
        <h3>ğŸ”´ ${acc.nama}</h3>
        <p><strong>Rekening:</strong> ${acc.rekening}</p>
        <p><strong>Status:</strong> ${acc.keterangan === 'ON' ? 'ON' : 'OFF'}</p>
      </div>
      <div class="alert-value">${fmtIDR(acc.saldo)}</div>
    `;
    listContainer.appendChild(item);
  });
  
  lowWdAccounts.forEach(acc => {
    const item = document.createElement('div');
    item.className = 'alert-item';
    item.innerHTML = `
      <div class="alert-info">
        <h3>${acc.nama}</h3>
        <p><strong>Rekening:</strong> ${acc.rekening}</p>
        <p><strong>Status:</strong> ${acc.keterangan === 'ON' ? 'ON' : 'OFF'}</p>
      </div>
      <div class="alert-value">${fmtIDR(acc.saldo)}</div>
    `;
    listContainer.appendChild(item);
  });
  
  document.getElementById('alertModal').classList.add('active');
}

async function render(){
  try {
    const values = await fetchSheetValues();
    allAccounts = [];

    for(let i=1; i<values.length; i++){
      const row = values[i];
      if(!row || row.length === 0) continue;

      const nama = (row[0]||'').trim();
      const saldoRaw = row[1] || '';
      const rekening = (row[2]||'').trim();
      const keterangan = (row[3]||'').toString().trim().toUpperCase();
      const biayaRaw = row[4] || '';

      if(!nama) continue;

      const saldo = parseNumber(saldoRaw);
      const biaya = parseNumber(biayaRaw);
      
      const isKas = nama.toUpperCase().includes('BANK KAS');
      const isWd = nama.toUpperCase().includes('WD') && !isKas;
      const accountType = isKas ? 'KAS' : isWd ? 'WD' : 'OTHER';
      
      let wdType = null;
      if(accountType === 'WD'){
        wdType = isWdKotor(nama) ? 'KOTOR' : 'BERSIH';
      }

      allAccounts.push({
        nama,
        saldo,
        rekening,
        keterangan,
        biaya,
        accountType,
        wdType,
      });
    }

    const q = (document.getElementById('search').value||'').toLowerCase();
    const accountType = document.getElementById('accountType').value;
    const wdFilter = document.getElementById('wdFilter').value;
    const viewFilter = document.getElementById('viewFilter').value;

    let filtered = allAccounts;
    if(accountType === 'wd'){
      filtered = filtered.filter(a => a.accountType === 'WD');
    } else if(accountType === 'kas'){
      filtered = filtered.filter(a => a.accountType === 'KAS');
    }

    if(wdFilter !== 'all'){
      filtered = filtered.filter(a => a.wdType?.toLowerCase() === wdFilter);
    }

    if(viewFilter === 'on'){
      filtered = filtered.filter(a => a.keterangan === 'ON');
    } else if(viewFilter === 'off'){
      filtered = filtered.filter(a => a.keterangan !== 'ON');
    }

    if(q){
      filtered = filtered.filter(a => 
        a.nama.toLowerCase().includes(q) || 
        a.rekening.toLowerCase().includes(q)
      );
    }

    filtered.sort((a,b)=>{
      const aIsNegative = a.saldo < 0;
      const bIsNegative = b.saldo < 0;
      const aIsLow = a.saldo > 0 && a.saldo <= 2000000;
      const bIsLow = b.saldo > 0 && b.saldo <= 2000000;

      if(aIsNegative && !bIsNegative) return -1;
      if(!aIsNegative && bIsNegative) return 1;
      if(aIsLow && !bIsLow && !bIsNegative) return -1;
      if(!aIsLow && bIsLow && !aIsNegative) return 1;
      return 0;
    });

    const activeAccounts = allAccounts.filter(a => a.keterangan === 'ON');
    const totalSaldo = activeAccounts.reduce((s,a)=>s+a.saldo, 0);
    const negativeAccounts = activeAccounts.filter(a=>a.saldo<0);
    const lowWdAccounts = activeAccounts.filter(a=>a.accountType==='WD' && a.saldo>0 && a.saldo<=2000000);
    const countNegative = negativeAccounts.length;
    const countLow = lowWdAccounts.length;
    const countOn = activeAccounts.length;

    document.getElementById('totalSaldo').textContent = fmtIDR(totalSaldo);
    document.getElementById('totalSaldo').className = totalSaldo < 0 ? 'card-value negative' : 'card-value';
    document.getElementById('countLow').textContent = countLow;
    document.getElementById('countNegative').textContent = countNegative;
    document.getElementById('countOn').textContent = countOn;

    const cardNegative = document.getElementById('cardNegative');
    const cardLow = document.getElementById('cardLow');
    if(countNegative > 0){
      cardNegative.style.display = 'block';
      cardNegative.classList.add('warning');
    } else {
      cardNegative.style.display = 'none';
    }

    if(countLow > 0){
      cardLow.classList.add('warning');
    } else {
      cardLow.classList.remove('warning');
    }

    const wdAccounts = filtered.filter(a => a.accountType === 'WD');
    const kasAccounts = filtered.filter(a => a.accountType === 'KAS');

    document.getElementById('wdTableCard').style.display = wdAccounts.length > 0 ? 'block' : 'none';
    document.getElementById('kasTableCard').style.display = kasAccounts.length > 0 ? 'block' : 'none';

    renderWdTable(wdAccounts);
    renderKasTable(kasAccounts);
    
    if(countNegative > 0 || countLow > 0){
      let msg = '';
      if(countNegative > 0 && countLow > 0){
        msg = `âš  ${countNegative} saldo minus & ${countLow} saldo rendah (WD <2juta)`;
      } else if(countNegative > 0){
        msg = `ğŸ”´ ${countNegative} saldo minus!`;
      } else {
        msg = `âš  ${countLow} saldo rendah (WD <2juta)`;
      }
      showToast(msg);
      if(shouldShowAlert){
        showAlertModal(negativeAccounts, lowWdAccounts);
        shouldShowAlert = false;
      }
    }

  } catch(err){
    console.error(err);
    alert('Error: ' + err.message);
  }
}

function renderWdTable(accounts){
  const tbody = document.getElementById('wdTableBody');
  tbody.innerHTML = '';

  accounts.forEach(acc => {
    const tr = document.createElement('tr');
    const isNegative = acc.saldo < 0;
    const isLow = acc.saldo > 0 && acc.saldo <= 2000000;
    const isOff = acc.keterangan !== 'ON';

    if(isNegative){
      tr.classList.add('row-negative');
    } else if(isOff){
      tr.classList.add('row-off');
    } else if(isLow){
      tr.classList.add('row-warning');
    }

    const statusPill = acc.keterangan === 'ON' 
      ? '<span class="pill success">âœ“ ON</span>'
      : '<span class="pill danger">âœ— OFF</span>';

    const wdTypePill = acc.wdType
      ? `<span class="pill ${acc.wdType.toLowerCase()}">${acc.wdType}</span>`
      : '-';

    tr.innerHTML = `
      <td><strong>${acc.nama}</strong></td>
      <td><strong style="font-family:'Exo 2',sans-serif;color:${isNegative?'var(--danger)':'inherit'}">${fmtIDR(acc.saldo)}</strong></td>
      <td style="font-family:monospace;font-size:13px;color:var(--text-muted)">${acc.rekening || '-'}</td>
      <td><strong style="font-family:'Exo 2',sans-serif">${fmtIDR(acc.biaya)}</strong></td>
      <td>${statusPill}</td>
      <td>${wdTypePill}</td>
      <td><button class="btn-edit" onclick="openEditModal('${acc.nama}')">âœ Edit</button></td>
    `;

    tbody.appendChild(tr);
  });
}

function renderKasTable(accounts){
  const tbody = document.getElementById('kasTableBody');
  tbody.innerHTML = '';

  accounts.forEach(acc => {
    const tr = document.createElement('tr');
    const isOff = acc.keterangan !== 'ON';

    if(isOff){
      tr.classList.add('row-off');
    }

    const statusPill = acc.keterangan === 'ON' 
      ? '<span class="pill success">âœ“ ON</span>'
      : '<span class="pill danger">âœ— OFF</span>';

    tr.innerHTML = `
      <td><strong>${acc.nama}</strong></td>
      <td><strong style="font-family:'Exo 2',sans-serif">${fmtIDR(acc.saldo)}</strong></td>
      <td style="font-family:monospace;font-size:13px;color:var(--text-muted)">${acc.rekening || '-'}</td>
      <td>${statusPill}</td>
      <td><button class="btn-edit" onclick="openEditModal('${acc.nama}')">âœ Edit</button></td>
    `;

    tbody.appendChild(tr);
  });
}

document.getElementById('refreshBtn').addEventListener('click', () => {
  shouldShowAlert = true;
  render();
});
document.getElementById('search').addEventListener('input', render);
document.getElementById('accountType').addEventListener('change', render);
document.getElementById('wdFilter').addEventListener('change', render);
document.getElementById('viewFilter').addEventListener('change', render);

document.getElementById('alertClose').addEventListener('click', closeAlertModal);
document.getElementById('alertCloseBtnFooter').addEventListener('click', closeAlertModal);
document.getElementById('editClose').addEventListener('click', closeEditModal);

document.getElementById('alertModal').addEventListener('click', (e) => {
  if(e.target.id === 'alertModal') closeAlertModal();
});

document.getElementById('editModal').addEventListener('click', (e) => {
  if(e.target.id === 'editModal') closeEditModal();
});

document.getElementById('editSaveBtn').addEventListener('click', () => {
  const nama = document.getElementById('editNama').value;
  const rekening = document.getElementById('editRekening').value;
  const saldo = parseNumber(document.getElementById('editSaldo').value);
  const biaya = parseNumber(document.getElementById('editBiaya').value);
  const status = document.getElementById('editStatus').value;
  
  const account = allAccounts.find(a => a.nama === nama);
  if(account){
    account.rekening = rekening;
    account.saldo = saldo;
    account.biaya = biaya;
    account.keterangan = status;
    
    showToast('âœ“ Data rekening berhasil diupdate!');
    closeEditModal();
    render();
  }
});

shouldShowAlert = true;
render();
</script>
</body>
</html>
